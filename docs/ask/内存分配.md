# 内存分配

我们实现的内存分配比较简单，主要是`伙伴算法`和一个简单（陋）的`Slab`



## 伙伴算法

```ini
+---------------------------------------------------------------------+
|                          Buddy System (Free Lists)                  |
+---------------------------------------------------------------------+
|                                                                     |
| Level 0: [2^0]  → □ ↔ □ ↔ □ ↔ ... (双向循环链表，块大小= PGSIZE * 1)   |
|                                                                     |
| Level 1: [2^1]  → ■ ↔ ■ ↔ ...     (块大小= PGSIZE * 2)               |
|                                                                     |
| Level 2: [2^2]  → ▣ ↔ ▣ ↔ ...     (块大小= PGSIZE * 4)              |
|                                                                     |
| Level 3: [2^3]  → ▩ ↔ ▩ ↔ ...     (块大小= PGSIZE * 8)              |
|                                                                     |
| Level 4: [2^4]  → ▢ ↔ ▢ ↔ ...     (块大小= PGSIZE * 16)             |
|                                                                     |
| Level 5: [2^5]  → □□ ↔ □□ ↔ ...  (块大小= PGSIZE * 32)               |
|                                                                     |
| Level 6: [2^6]  → ■■ ↔ ■■ ↔ ...  (块大小= PGSIZE * 64)               |
|                                                                     |
| Level 7: [2^7]  → ▣▣ ↔ ▣▣ ↔ ...  (块大小= PGSIZE * 128)            |
|                                                                     |
| Level 8: [2^8]  → ▩▩ ↔ ▩▩ ↔ ...  (块大小= PGSIZE * 256)            |
|                                                                     |
| Level 9: [2^9]  → ▢▢ ↔ ▢▢ ↔ ...  (块大小= PGSIZE * 512)            |
|                                                                     |
| Level 10: [2^10]  → □□□□ ↔ □□□□ ↔ ...  (块大小= PGSIZE * 1024)       |
|                                                                     |
+---------------------------------------------------------------------+
```

### 核心算法

```c
// 寻找当前 page 的伙伴
static struct page *find_buddy(const struct page *page, const int order)
{
    uint64_t index = get_pg_index(page);
    uint64_t buddy_index = index ^ (1UL << order);
  	...
}
```



## Slab

 TODO

